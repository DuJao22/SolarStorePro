{% extends "admin/base_admin.html" %}

{% block title %}{{ 'Editar' if produto else 'Novo' }} Produto - Admin SolarPro{% endblock %}
{% block page_title %}{{ 'Editar' if produto else 'Novo' }} Produto{% endblock %}

{% block extra_css %}
<style>
.imagem-slot {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #fafafa;
}
.imagem-slot.has-image {
    border-color: #0B6A4A;
    background: #f0f9f6;
}
.imagem-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.imagem-header h4 {
    margin: 0;
    font-size: 0.9rem;
    color: #333;
}
.imagem-toggle {
    display: flex;
    gap: 0.5rem;
}
.imagem-toggle button {
    padding: 0.25rem 0.75rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
}
.imagem-toggle button.active {
    background: #0B6A4A;
    color: white;
    border-color: #0B6A4A;
}
.imagem-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.imagem-input-group input[type="text"] {
    flex: 1;
}
.imagem-input-group input[type="file"] {
    flex: 1;
}
.imagem-preview {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}
.imagem-preview img {
    max-width: 120px;
    max-height: 80px;
    border-radius: 4px;
    object-fit: cover;
    border: 1px solid #ddd;
}
.imagem-preview .remove-btn {
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    font-size: 0.8rem;
}
.upload-btn {
    background: #0B6A4A;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
}
.upload-btn:hover {
    background: #095a3d;
}
.upload-status {
    font-size: 0.8rem;
    margin-top: 0.25rem;
}
.upload-status.success { color: #28a745; }
.upload-status.error { color: #dc3545; }
.upload-status.loading { color: #ffc107; }

.lucro-display {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1rem;
    border-radius: 8px;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.lucro-display.positivo {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: #28a745;
}
.lucro-display.negativo {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border-color: #dc3545;
}
.lucro-valor {
    font-size: 1.25rem;
    font-weight: 700;
    color: #333;
}
.lucro-display.positivo .lucro-valor { color: #28a745; }
.lucro-display.negativo .lucro-valor { color: #dc3545; }
.lucro-percentual {
    font-size: 0.9rem;
    color: #666;
    font-weight: 600;
}
.lucro-display.positivo .lucro-percentual { color: #1e7e34; }
.lucro-display.negativo .lucro-percentual { color: #bd2130; }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="header-title">
        <span class="header-icon">üì¶</span>
        <h1>{{ 'Editar' if produto else 'Novo' }} Produto</h1>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('admin_produtos') }}" class="btn btn-outline">
            ‚Üê Voltar para Produtos
        </a>
    </div>
</div>

<div class="admin-card">
    <div class="card-header">
        <h2 class="card-title">Informa√ß√µes do Produto</h2>
    </div>

    <form method="POST" enctype="multipart/form-data" id="produtoForm">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Nome do Produto <span class="required">*</span></label>
                <input type="text" name="nome" class="form-control"
                       value="{{ produto.nome if produto else '' }}"
                       placeholder="Ex: Painel Solar 550W Monocristalino"
                       required>
                <span class="form-hint">Nome completo e descritivo do produto</span>
            </div>

            <div class="form-group">
                <label class="form-label">Categoria <span class="required">*</span></label>
                <select name="categoria" class="form-control" required>
                    <option value="">Selecione uma categoria</option>
                    {% for cat in ['Residencial', 'Comercial', 'Kit Completo', 'Inversor'] %}
                    <option value="{{ cat }}" {{ 'selected' if produto and produto.categoria == cat else '' }}>{{ cat }}</option>
                    {% endfor %}
                </select>
                <span class="form-hint">Categoria do produto no cat√°logo</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Descri√ß√£o</label>
            <textarea name="descricao" class="form-control" rows="4"
                      placeholder="Descri√ß√£o detalhada do produto, especifica√ß√µes e benef√≠cios">{{ produto.descricao if produto else '' }}</textarea>
            <span class="form-hint">M√°ximo de 500 caracteres recomendado</span>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Custo (R$) <span class="required">*</span></label>
                <input type="number" step="0.01" name="custo" class="form-control" id="custo"
                       value="{{ produto.custo if produto and produto.custo else '' }}"
                       placeholder="0.00"
                       required>
                <span class="form-hint">Valor de custo/compra do produto</span>
            </div>

            <div class="form-group">
                <label class="form-label">Pre√ßo de Venda (R$) <span class="required">*</span></label>
                <input type="number" step="0.01" name="preco" class="form-control" id="preco"
                       value="{{ produto.preco if produto else '' }}"
                       placeholder="0.00"
                       required>
                <span class="form-hint">Pre√ßo de venda ao cliente</span>
            </div>

            <div class="form-group">
                <label class="form-label">Pre√ßo Promocional (R$)</label>
                <input type="number" step="0.01" name="preco_promocional" class="form-control"
                       value="{{ produto.preco_promocional if produto and produto.preco_promocional else '' }}"
                       placeholder="0.00">
                <span class="form-hint">Deixe em branco se n√£o houver promo√ß√£o</span>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Lucro Estimado</label>
                <div class="lucro-display" id="lucroDisplay">
                    <span class="lucro-valor" id="lucroValor">R$ 0,00</span>
                    <span class="lucro-percentual" id="lucroPercentual">(0%)</span>
                </div>
                <span class="form-hint">Calculado automaticamente: Pre√ßo - Custo</span>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Pot√™ncia (W) <span class="required">*</span></label>
                <input type="number" name="potencia_watts" class="form-control"
                       value="{{ produto.potencia_watts if produto else '' }}"
                       placeholder="550"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label">Efici√™ncia (%) <span class="required">*</span></label>
                <input type="number" step="0.1" name="eficiencia" class="form-control"
                       value="{{ produto.eficiencia if produto else '' }}"
                       placeholder="22.5"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label">Garantia (anos) <span class="required">*</span></label>
                <input type="number" name="garantia" class="form-control"
                       value="{{ produto.garantia if produto else '25' }}"
                       placeholder="25"
                       required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Estoque <span class="required">*</span></label>
                <input type="number" name="estoque" class="form-control"
                       value="{{ produto.estoque if produto else '' }}"
                       placeholder="0"
                       required>
                <span class="form-hint">Quantidade dispon√≠vel em estoque</span>
            </div>

            <div class="form-group">
                <label class="form-label">Estoque M√≠nimo</label>
                <input type="number" name="estoque_minimo" class="form-control"
                       value="{{ produto.estoque_minimo if produto else 5 }}"
                       placeholder="5">
                <span class="form-hint">Quantidade m√≠nima para alerta de estoque baixo</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Imagens do Produto (at√© 5)</label>
            <span class="form-hint">Adicione imagens via URL ou fa√ßa upload de arquivos. A primeira imagem ser√° a principal.</span>
            
            <div id="imagensContainer">
                {% set imagens_existentes = [] %}
                {% if produto and produto.imagens %}
                    {% set imagens_existentes = produto.imagens|from_json %}
                {% elif produto and produto.imagem %}
                    {% set imagens_existentes = [produto.imagem] %}
                {% endif %}
                
                {% for i in range(1, 6) %}
                <div class="imagem-slot {% if imagens_existentes[i-1] %}has-image{% endif %}" id="imagemSlot{{ i }}">
                    <div class="imagem-header">
                        <h4>Imagem {{ i }}{% if i == 1 %} (Principal){% endif %}</h4>
                        <div class="imagem-toggle">
                            <button type="button" class="toggle-link active" data-slot="{{ i }}">Link URL</button>
                            <button type="button" class="toggle-upload" data-slot="{{ i }}">Upload</button>
                        </div>
                    </div>
                    
                    <div class="imagem-input-group link-input" id="linkInput{{ i }}">
                        <input type="text" name="imagem_{{ i }}" id="imagem{{ i }}" class="form-control"
                               value="{{ imagens_existentes[i-1] if imagens_existentes|length >= i else '' }}"
                               placeholder="URL da imagem ou nome do arquivo (ex: produto.jpg)">
                    </div>
                    
                    <div class="imagem-input-group upload-input" id="uploadInput{{ i }}" style="display: none;">
                        <input type="file" id="fileInput{{ i }}" accept="image/*" class="form-control">
                        <button type="button" class="upload-btn" onclick="uploadImage({{ i }})">Enviar</button>
                    </div>
                    
                    <div class="upload-status" id="uploadStatus{{ i }}"></div>
                    
                    <div class="imagem-preview" id="preview{{ i }}" {% if not imagens_existentes[i-1] %}style="display: none;"{% endif %}>
                        {% if imagens_existentes[i-1] %}
                        <img src="/static/images/products/{{ imagens_existentes[i-1] }}" 
                             onerror="this.src='{{ imagens_existentes[i-1] }}'"
                             alt="Preview {{ i }}">
                        {% else %}
                        <img src="" alt="Preview {{ i }}">
                        {% endif %}
                        <button type="button" class="remove-btn" onclick="removeImage({{ i }})">Remover</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Especifica√ß√µes (JSON)</label>
            <textarea id="especificacoes" name="especificacoes" rows="4" class="form-control"
                      placeholder='{"dimensoes": "...", "peso": "..."}'>{{ produto.especificacoes if produto else '' }}</textarea>
            <span class="form-hint">Formato JSON para detalhes t√©cnicos como dimens√µes, peso, etc.</span>
        </div>

        <div class="form-row">
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="ativo" {{ 'checked' if not produto or produto.ativo else '' }}>
                    Produto Ativo
                </label>
            </div>
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="destaque" {{ 'checked' if produto and produto.destaque else '' }}>
                    Produto em Destaque
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                ‚úì Salvar Produto
            </button>
            <a href="{{ url_for('admin_produtos') }}" class="btn btn-outline">
                Cancelar
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.toggle-link').forEach(btn => {
    btn.addEventListener('click', function() {
        const slot = this.dataset.slot;
        document.getElementById('linkInput' + slot).style.display = 'flex';
        document.getElementById('uploadInput' + slot).style.display = 'none';
        this.classList.add('active');
        this.nextElementSibling.classList.remove('active');
    });
});

document.querySelectorAll('.toggle-upload').forEach(btn => {
    btn.addEventListener('click', function() {
        const slot = this.dataset.slot;
        document.getElementById('linkInput' + slot).style.display = 'none';
        document.getElementById('uploadInput' + slot).style.display = 'flex';
        this.classList.add('active');
        this.previousElementSibling.classList.remove('active');
    });
});

document.querySelectorAll('input[name^="imagem_"]').forEach(input => {
    input.addEventListener('input', function() {
        const slot = this.name.replace('imagem_', '');
        updatePreview(slot, this.value);
    });
});

function updatePreview(slot, value) {
    const preview = document.getElementById('preview' + slot);
    const img = preview.querySelector('img');
    const slotDiv = document.getElementById('imagemSlot' + slot);
    
    if (value) {
        let src = value;
        if (!value.startsWith('http') && !value.startsWith('/')) {
            src = '/static/images/products/' + value;
        }
        img.src = src;
        img.onerror = function() {
            this.src = value;
        };
        preview.style.display = 'flex';
        slotDiv.classList.add('has-image');
    } else {
        preview.style.display = 'none';
        slotDiv.classList.remove('has-image');
    }
}

function uploadImage(slot) {
    const fileInput = document.getElementById('fileInput' + slot);
    const statusEl = document.getElementById('uploadStatus' + slot);
    
    if (!fileInput.files[0]) {
        statusEl.textContent = 'Selecione um arquivo primeiro.';
        statusEl.className = 'upload-status error';
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    statusEl.textContent = 'Enviando...';
    statusEl.className = 'upload-status loading';
    
    fetch('/admin/upload-imagem', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            document.getElementById('imagem' + slot).value = data.filename;
            updatePreview(slot, data.filename);
            statusEl.textContent = 'Upload conclu√≠do!';
            statusEl.className = 'upload-status success';
            
            document.getElementById('linkInput' + slot).style.display = 'flex';
            document.getElementById('uploadInput' + slot).style.display = 'none';
            document.querySelector('.toggle-link[data-slot="' + slot + '"]').classList.add('active');
            document.querySelector('.toggle-upload[data-slot="' + slot + '"]').classList.remove('active');
        } else {
            statusEl.textContent = data.erro;
            statusEl.className = 'upload-status error';
        }
    })
    .catch(error => {
        statusEl.textContent = 'Erro ao enviar arquivo.';
        statusEl.className = 'upload-status error';
    });
}

function removeImage(slot) {
    document.getElementById('imagem' + slot).value = '';
    document.getElementById('preview' + slot).style.display = 'none';
    document.getElementById('imagemSlot' + slot).classList.remove('has-image');
    document.getElementById('uploadStatus' + slot).textContent = '';
}

function calcularLucro() {
    const custo = parseFloat(document.getElementById('custo').value) || 0;
    const preco = parseFloat(document.getElementById('preco').value) || 0;
    const lucro = preco - custo;
    const percentual = custo > 0 ? ((lucro / custo) * 100) : 0;
    
    const display = document.getElementById('lucroDisplay');
    const valorEl = document.getElementById('lucroValor');
    const percentualEl = document.getElementById('lucroPercentual');
    
    valorEl.textContent = 'R$ ' + lucro.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    percentualEl.textContent = '(' + percentual.toFixed(1).replace('.', ',') + '%)';
    
    display.classList.remove('positivo', 'negativo');
    if (lucro > 0) {
        display.classList.add('positivo');
    } else if (lucro < 0) {
        display.classList.add('negativo');
    }
}

document.getElementById('custo').addEventListener('input', calcularLucro);
document.getElementById('preco').addEventListener('input', calcularLucro);

calcularLucro();
</script>
{% endblock %}
