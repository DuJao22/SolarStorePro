{% extends "admin/base_admin.html" %}

{% block title %}Pedido #{{ pedido.id }} - Admin SolarPro{% endblock %}
{% block page_title %}Pedido #{{ pedido.id }}{% endblock %}

{% block content %}
<div class="detail-layout">
    <div class="detail-main">
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Produtos do Pedido</h3>
            </div>
            <div class="card-body">
                {% set produtos = pedido.produtos_json|from_json %}
                <table class="data-table full-width">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Preço Un.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in produtos %}
                        <tr>
                            <td>{{ item.nome }}</td>
                            <td>{{ item.quantidade }}</td>
                            <td>{{ item.preco_unitario|format_price }}</td>
                            <td>{{ item.subtotal|format_price }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right"><strong>Subtotal:</strong></td>
                            <td>{{ pedido.subtotal|format_price }}</td>
                        </tr>
                        {% if pedido.desconto > 0 %}
                        <tr>
                            <td colspan="3" class="text-right"><strong>Desconto{% if pedido.cupom_usado %} ({{ pedido.cupom_usado }}){% endif %}:</strong></td>
                            <td class="text-success">-{{ pedido.desconto|format_price }}</td>
                        </tr>
                        {% endif %}
                        <tr class="total-row">
                            <td colspan="3" class="text-right"><strong>Total:</strong></td>
                            <td><strong>{{ pedido.total|format_price }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Atualizar Status</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin_atualizar_status_pedido', id=pedido.id) }}" class="status-form">
                    <select name="status" class="status-select">
                        {% for status in ['aguardando_pagamento', 'pago', 'processando', 'enviado', 'entregue', 'cancelado'] %}
                        <option value="{{ status }}" {{ 'selected' if pedido.status_pedido == status else '' }}>
                            {{ status|replace('_', ' ')|title }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                </form>
            </div>
        </div>
    </div>
    
    <aside class="detail-sidebar">
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Cliente</h3>
            </div>
            <div class="card-body">
                <p><strong>{{ pedido.cliente_nome or pedido.nome_cliente }}</strong></p>
                <p>{{ pedido.cliente_email or pedido.email }}</p>
                <p>{{ pedido.cliente_telefone or pedido.telefone }}</p>
                {% if pedido.cpf %}<p>CPF: {{ pedido.cpf }}</p>{% endif %}
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Endereço de Entrega</h3>
            </div>
            <div class="card-body">
                <p>{{ pedido.endereco }}</p>
                <p>{{ pedido.cidade }} - {{ pedido.estado }}</p>
                <p>CEP: {{ pedido.cep }}</p>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Pagamento</h3>
            </div>
            <div class="card-body">
                <p><span class="badge badge-{{ pedido.status_pagamento }}">{{ pedido.status_pagamento|title }}</span></p>
                {% if pedido.mercadopago_id %}
                <p><small>ID MP: {{ pedido.mercadopago_id }}</small></p>
                {% endif %}
                {% if pedido.data_pagamento %}
                <p><small>Pago em: {{ pedido.data_pagamento|format_date }}</small></p>
                {% endif %}
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Datas</h3>
            </div>
            <div class="card-body">
                <p><strong>Pedido:</strong> {{ pedido.data|format_date }}</p>
                {% if pedido.data_envio %}<p><strong>Envio:</strong> {{ pedido.data_envio|format_date }}</p>{% endif %}
                {% if pedido.data_entrega %}<p><strong>Entrega:</strong> {{ pedido.data_entrega|format_date }}</p>{% endif %}
            </div>
        </div>
    </aside>
</div>

<div class="page-actions bottom">
    <a href="{{ url_for('admin_pedidos') }}" class="btn btn-outline">Voltar aos Pedidos</a>
</div>
{% endblock %}
