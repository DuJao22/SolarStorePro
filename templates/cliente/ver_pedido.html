{% extends "base.html" %}

{% block title %}Pedido #{{ pedido.id }} - SolarPro{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1 data-aos="fade-up">Pedido #{{ pedido.id }}</h1>
        <p data-aos="fade-up" data-aos-delay="100">{{ pedido.data|format_date }}</p>
    </div>
</section>

<section class="order-detail-section">
    <div class="container">
        <div class="order-detail-layout">
            <div class="order-main" data-aos="fade-up">
                <div class="status-timeline">
                    <div class="status-step {{ 'active' if pedido.status_pedido in ['aguardando_pagamento', 'pago', 'processando', 'enviado', 'entregue'] else '' }}">
                        <div class="step-icon">ðŸ“‹</div>
                        <span>Pedido Realizado</span>
                    </div>
                    <div class="status-step {{ 'active' if pedido.status_pedido in ['pago', 'processando', 'enviado', 'entregue'] else '' }}">
                        <div class="step-icon">ðŸ’³</div>
                        <span>Pagamento Confirmado</span>
                    </div>
                    <div class="status-step {{ 'active' if pedido.status_pedido in ['processando', 'enviado', 'entregue'] else '' }}">
                        <div class="step-icon">ðŸ“¦</div>
                        <span>Em PreparaÃ§Ã£o</span>
                    </div>
                    <div class="status-step {{ 'active' if pedido.status_pedido in ['enviado', 'entregue'] else '' }}">
                        <div class="step-icon">ðŸšš</div>
                        <span>Enviado</span>
                    </div>
                    <div class="status-step {{ 'active' if pedido.status_pedido == 'entregue' else '' }}">
                        <div class="step-icon">âœ…</div>
                        <span>Entregue</span>
                    </div>
                </div>
                
                <div class="order-products-detail">
                    <h3>Produtos</h3>
                    {% set produtos = pedido.produtos_json|from_json %}
                    {% for item in produtos %}
                    <div class="product-row">
                        <div class="product-info">
                            <span class="product-qty">{{ item.quantidade }}x</span>
                            <span class="product-name">{{ item.nome }}</span>
                        </div>
                        <div class="product-prices">
                            <span class="unit-price">{{ item.preco_unitario|format_price }} un.</span>
                            <span class="subtotal">{{ item.subtotal|format_price }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if pedido.status_pedido == 'aguardando_pagamento' %}
                <div class="payment-action">
                    <p>Seu pedido estÃ¡ aguardando pagamento.</p>
                    <button class="btn btn-primary btn-lg" onclick="iniciarPagamento({{ pedido.id }})">Pagar Agora</button>
                </div>
                {% endif %}
            </div>
            
            <aside class="order-sidebar" data-aos="fade-left">
                <div class="sidebar-card">
                    <h4>Resumo</h4>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>{{ pedido.subtotal|format_price }}</span>
                    </div>
                    {% if pedido.desconto > 0 %}
                    <div class="summary-row discount">
                        <span>Desconto{% if pedido.cupom_usado %} ({{ pedido.cupom_usado }}){% endif %}</span>
                        <span>-{{ pedido.desconto|format_price }}</span>
                    </div>
                    {% endif %}
                    <div class="summary-row total">
                        <span>Total</span>
                        <span>{{ pedido.total|format_price }}</span>
                    </div>
                </div>
                
                <div class="sidebar-card">
                    <h4>EndereÃ§o de Entrega</h4>
                    <p>
                        {{ pedido.endereco }}<br>
                        {{ pedido.cidade }} - {{ pedido.estado }}<br>
                        CEP: {{ pedido.cep }}
                    </p>
                </div>
                
                <div class="sidebar-card">
                    <h4>Status do Pagamento</h4>
                    <span class="payment-status status-{{ pedido.status_pagamento }}">
                        {{ pedido.status_pagamento|title }}
                    </span>
                </div>
            </aside>
        </div>
        
        <a href="{{ url_for('meus_pedidos') }}" class="btn btn-outline">Voltar aos Pedidos</a>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
async function iniciarPagamento(pedidoId) {
    try {
        const response = await fetch('/criar-pagamento', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pedido_id: pedidoId })
        });
        
        const data = await response.json();
        
        if (data.erro) {
            alert(data.erro);
            return;
        }
        
        window.location.href = data.init_point;
    } catch (error) {
        alert('Erro ao processar pagamento. Tente novamente.');
    }
}
</script>
{% endblock %}
